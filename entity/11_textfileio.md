# テキストファイル入出力

Cではファイルなどにデータを書き込んだり、ファイルからデータを読んだりするために必要な関数やデータ型をまとめて定義してある`stdio.h`というヘッダファイルがある。プログラマーはハードディスクやOSのことを考えることなくCの標準ライブラリによってIOを管理することができる。Cの標準ライブラリを用いてファイルを扱うときは`#include <stdio.h>`と書く必要がある。

ファイルへの入出力には`FILE`オブジェクトを使う。`FILE`オブジェクトはCの規格書[N1570](http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1570.pdf)で以下のように定められている。

>`FILE`は、ファイル位置表示子, 結びつけられたバッファへのポインタ, 読み取りエラーまたは書き込みエラーが起こったかどうかを記録するエラー表示子(*error indicator*), ファイルの終わりに到達したかどうかを記録するファイル終了表示子(*end-of-file indicator*)などストリームを制御するために必要なすべての情報を記録することのできるオブジェクト型とする。

`FILE`オブジェクトを構築すればファイルへの入出力ができるというわけだ。

## ファイルをオープン

ファイルを操作するためにはファイルをオープンする。`FILE`オブジェクトを構築して、ファイルをオープンするためには`fopen_s`関数を使う。`fopen_s`関数には`FILE`オブジェクトへの[ポインタ]()のポインタとファイル名とファイルのオープンモードを指定する。ファイルのオープンモードには様々あるが、ここでは`"r"`と`"w"`しか使わないことにする。気になる読者はインターネットでfopen_sについて検索すると良いだろう。

- "r"

    テキストファイルを読み取りモードでオープンする

- "w"

    テキストファイルを書き込みモードで作成するか、または長さ0に切り捨てる。

`fopen_s`関数に`"r"`か`"w"`のようなモードを指定するとファイルはテキストストリームに写像される。Cではテキストストリームのほかにバイナリストリームという論理データストリーム(*stream*)を定めている。バイナリストリームはファイルの中身を1ビットも変えずに出力または入力する。テキストストリームではホスト環境内でテキストを表現する異なった規約に合わせるために、入力および出力の際に文字を付加、変更または削除してもよいことになっている。具体的には改行文字やそのほかの制御文字が付加、変更または削除の対象になる。

開いたファイルをクローズするには`fclose`関数を用いる。`FILE`オブジェクトのポインタを渡せばファイルを閉じてくれる。

```c
#include <stdio.h>

int main(void) {
    FILE* fp;
    fopen_s(&fp, "file.txt", "w");  // ファイルをオープン
    fclose(fp);                     // ファイルをクローズ
}

```

ファイルのオープンには失敗する可能性がある。`fopen_s`はファイルのオープンに失敗すると`0`以外の戻り値を返す。成功すれば`0`を返す。エラーも考慮したコードは以下のようになる。

```c
#include <stdio.h>

int main(void) {
    FILE* fp;
    if (fopen_s("file.txt", "w"))
        return 0;                   // ファイルをオープンできなかった
    fclose(fp);
}
```

## ファイルへの書き込み

ファイルにデータを書き込むにはファイルを書き込みモードで開いて出力関数を用いる必要がある。ここではよく使われる出力関数をいくつか使用例とともに紹介するにとどめる。

### fputc

最も簡単な出力関数は`fputc`だ。この関数はストリームに1文字書き込む。

```c
// fputc_sample.c
#include <stdio.h>

int main(void) {
    FILE* fp;
    if (fopen_s(&fp, "file.txt", "w"))
        return 0;

    fputc('a', fp);     // ファイルにaという1文字を書き込む。
    fclose(fp);
}
```

### fputs

文字のほかに文字列を書き込むことができる。Cではストリームに文字列を書き込む関数は`fputs`だ。

```c
// fputs_sample.c
#include <stdio.h>

int main(void) {
    FILE* fp;
    if (fopen_s(&fp, "file.txt", "w"))
        return 0;
    fputs("C programming language", fp);
}
```

### fprintf_s

時には変数の内容を書き込みたいこともあるだろう。Cでは書式付き文字列を書き込むことができる。書式付き文字列をストリームに書き込むには`fprintf_s`関数を使用する。`fprintf_s`関数は第三引数以降の実引数を、書式文字列に書かれた変換方法に従って出力する。書式文字列には変換指定子を書いて実引数を変換する。変換指定子にはさまざまあるためここではすべてを紹介できないが、気になる読者はC言語の規格書[N1570](http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1570.pdf)の7.21.6辺りをみるとすべての変換指定子の一覧と詳細を知ることができる。

例えば整数値を変換して出力するには`%d`という変換指定子を使う。浮動小数点数には`%f`、文字には`%c`、[ヌル文字で終わる文字列]()には`%s`など、表示したいデータ型に合わせた変換指定子を使う必要がある。

また、変換指定子は表示したい値の数だけ過不足なく書くほうが良い。変換指定子の数が実引数より多ければそれは未定義動作となる。

```c
// fprintf_s_sample.c
#include <stdio.h>

int main(void) {
    FILE* fp;
    if (fopen_s(&fp, "file.txt", "w"))
        return 0;
    int value = 13;
    fprintf_s(fp, "The value is %d\n", value);
}
/*output
The value is 13

 */
```

## ファイルからの入力

ファイルからデータを読み込むためには読み取りモードでファイルをオープンし、入力関数を使う必要がある。ここでは簡単な入力関数を使用例と共に紹介するにとどめる。

### fgetc

最も簡単な入力関数は`fgetc`だ。ストリームから1文字読み込んで返す。読み取りエラーが発生した場合はストリームのエラー表示子をセットし、EOFを返す。以下のサンプルではファイルの先頭から1文字読み込んで[標準出力]()にその内容を出力する。

```c
// fgetc_sample.c
#include <stdio.h>

int main(void) {
    FILE* fp;
    if (fopen_s(&fp, "file.txt", "r"))
        return 0;
    int value = fgetc(fp);
    fprintf_s(stdout, "%d\n", value);
}
```

### fgets

ファイルから1行読み込む関数は`fgets`だ。この関数は[文字列のポインタ]()とそのサイズ、そしてストリームへのポインタを受け取る。読み取る最大の文字数は`第二引数の値-1`文字までで、最後にはヌル文字を書き込む。`fgets`関数は成功すると読み取った文字列へのポインタ:第一引数を返す。1文字も読み取らずファイルの終わりを検出した場合`NULL`を返す。この時第一引数で渡した[配列]()の内容は変化しない。読み取りエラーが発生した場合も`NULL`を返すが、その場合の配列の名前は不定となる。

```c
// fgets_sample.c
#include <stdio.h>

int main(void) {
    FILE* fp;
    if (fopen_s(&fp, "file.txt", "r"))
        return 0;
    char line[256];
    fgets(line, 256, fp);
    fputs(line, stdout);
}
```

### fscanf_s

`fscanf_s`では書式文字列を用いて変数に入力することができる。変換指定子は`fprintf_s`とほぼ同じだ。一つ注意すべき点があるとすれば`float`と`double`で指定すべき変換指定子が違うことだ。`%f`指定子は`float`型への[ポインタ]()の実引数に、`%lf`指定子は`double`型へのポインタの実引数に対応させる必要がある。また、`fscanf_s`の第二引数より後の実引数は**ポインタ**でなくてはならない。`fscanf_s`関数は成功すれば読み込みに成功した入力アイテムの数を返す。伝送の前に入力エラーが発生した若しくは実行時制約違反の場合は`EOF`を返す。

```c

#include <stdio.h>

int main(void) {
    FILE* fp;
    if (fopen_s(&fp, "file.txt", "r"))
        return 0;
    int value;
    fscanf_s(fp, "%d", &value);
    fprintf_s(fp, "%d\n", value);
}
```
