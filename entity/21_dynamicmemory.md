# 動的メモリ

動的メモリとは、実行時に必要な分だけ確保できるメモリのことだ。これまでのプログラムに登場した変数、配列、定数などはすべて静的 (コンパイル時にサイズなどが決まる) であった。例えばユーザーに文字を入力させるとき500バイトの文字型配列を宣言しても入力された文字が50バイトならば、450バイトが無駄になってしまう。逆に、501バイトの入力があった場合はバッファオーバーランを起こしてスタックの情報を破壊してしまう。そのようなことは動的メモリで解決できる。

動的にメモリを確保するには`stdlib.h`をインクルードして`malloc`関数を使う。`malloc`関数に欲しいメモリのサイズを渡すと、ヒープ領域からメモリを確保して、確保したメモリチャンクの先頭アドレスを返してくれる。また、確保したメモリは不要になった時点で`free`関数で解放しなければならない。`malloc`がメモリの確保に失敗した場合は`NULL`を返す。`free`に`NULL`を渡した場合何もしないと規定されている。

```c
void* memory = malloc(10);  // 10byte メモリを確保する
free(memory);               // 確保したメモリを解放する
```

`malloc`で確保された領域は如何なる型にも使用できる。例えば任意の個数の`long`型の入力を受け取ってみよう。入力は、最初にデータの数があり、実際のデータが後に続く。

```c
#include <stdlib.h>

int main(void) {
    long* ptr;
    size_t n;
    // データの数
    scanf_s("%z", &n);

    // malloc( long型のサイズ * データの数 )
    if(!(ptr = (long*)malloc(sizeof long * n)))
        return 0;   // メモリ確保に失敗すれば終了する
    
    for(size_t i = 0; i < n; ++i) {
        scanf("%l", ptr + i);
    }
    free(ptr);
    // メモリを解放した後のポインタにはNULLを代入しておくと二重解放の心配がない。
    ptr = NULL;
}
```


